{% extends "base.html" %}

{% block title %}Logy - WebDAV Uploader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Systémové logy</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Obnovit
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportLogs()">
                <i class="bi bi-download"></i> Export
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                <i class="bi bi-trash"></i> Vymazat
            </button>
        </div>
    </div>
</div>

<!-- Filtry -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-funnel"></i> Filtry</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="filter_user" class="form-label">Uživatel</label>
                <select class="form-select" id="filter_user" onchange="applyFilters()">
                    <option value="">Všichni</option>
                    {% for log in logs %}
                        {% if log[0] not in filter_users %}
                            {% set _ = filter_users.append(log[0]) if filter_users is defined else filter_users.__setitem__('filter_users', [log[0]]) %}
                        {% endif %}
                    {% endfor %}
                    {% set filter_users = [] %}
                    {% for log in logs %}
                        {% if log[0] and log[0] not in filter_users %}
                            {% set _ = filter_users.append(log[0]) %}
                            <option value="{{ log[0] }}">{{ log[0] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter_action" class="form-label">Akce</label>
                <select class="form-select" id="filter_action" onchange="applyFilters()">
                    <option value="">Všechny</option>
                    <option value="login">Přihlášení</option>
                    <option value="login_attempt">Pokus o přihlášení</option>
                    <option value="logout">Odhlášení</option>
                    <option value="file_upload">Upload souboru</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter_success" class="form-label">Výsledek</label>
                <select class="form-select" id="filter_success" onchange="applyFilters()">
                    <option value="">Všechny</option>
                    <option value="1">Úspěšné</option>
                    <option value="0">Neúspěšné</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter_date" class="form-label">Datum</label>
                <input type="date" class="form-control" id="filter_date" onchange="applyFilters()">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Vymazat filtry
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tabulka logů -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="bi bi-list-ul"></i> Přístupové logy</h5>
        <span class="badge bg-primary" id="logs-count">{{ logs|length }} záznamů</span>
    </div>
    <div class="card-body">
        {% if logs %}
        <div class="table-responsive">
            <table class="table table-hover table-sm" id="logsTable">
                <thead>
                    <tr>
                        <th><i class="bi bi-clock"></i> Čas</th>
                        <th><i class="bi bi-person"></i> Uživatel</th>
                        <th><i class="bi bi-geo"></i> IP adresa</th>
                        <th><i class="bi bi-activity"></i> Akce</th>
                        <th><i class="bi bi-check-circle"></i> Výsledek</th>
                        <th><i class="bi bi-info-circle"></i> Detaily</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr class="log-row" 
                        data-user="{{ log[0] or '' }}" 
                        data-action="{{ log[2] }}" 
                        data-success="{{ log[3] }}" 
                        data-date="{{ log[4][:10] if log[4] else '' }}">
                        <td>
                            <small>{{ log[4][11:19] if log[4] else 'N/A' }}</small><br>
                            <small class="text-muted">{{ log[4][:10] if log[4] else 'N/A' }}</small>
                        </td>
                        <td>
                            {% if log[0] %}
                                <strong>{{ log[0] }}</strong>
                            {% else %}
                                <span class="text-muted">Neznámý</span>
                            {% endif %}
                        </td>
                        <td>
                            <code>{{ log[1] or 'N/A' }}</code>
                        </td>
                        <td>
                            {% set action_icons = {
                                'login': 'box-arrow-in-right',
                                'login_attempt': 'shield-exclamation', 
                                'logout': 'box-arrow-right',
                                'file_upload': 'upload'
                            } %}
                            {% set action_names = {
                                'login': 'Přihlášení',
                                'login_attempt': 'Pokus o přihlášení',
                                'logout': 'Odhlášení', 
                                'file_upload': 'Upload souboru'
                            } %}
                            <i class="bi bi-{{ action_icons.get(log[2], 'question-circle') }}"></i>
                            {{ action_names.get(log[2], log[2]) }}
                        </td>
                        <td>
                            {% if log[3] %}
                                <span class="badge bg-success">Úspěch</span>
                            {% else %}
                                <span class="badge bg-danger">Chyba</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log[5] %}
                                <small class="text-muted">{{ log[5][:50] }}{% if log[5]|length > 50 %}...{% endif %}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Navigace v lozích" class="mt-3">
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item disabled">
                    <span class="page-link">Předchozí</span>
                </li>
                <li class="page-item active">
                    <span class="page-link">1</span>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">2</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">3</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">Další</a>
                </li>
            </ul>
        </nav>
        {% else %}
        <div class="text-center py-4">
            <i class="bi bi-journal-x fs-1 text-muted"></i>
            <h5 class="mt-3 text-muted">Žádné logy</h5>
            <p class="text-muted">Zatím nejsou k dispozici žádné přístupové logy.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Statistiky -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h5 class="text-success" id="success-count">
                    {{ logs | selectattr('3') | list | length }}
                </h5>
                <small class="text-muted">Úspěšné akce</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h5 class="text-danger" id="failure-count">
                    {{ (logs | length) - (logs | selectattr('3') | list | length) }}
                </h5>
                <small class="text-muted">Neúspěšné akce</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h5 class="text-primary" id="unique-users">
                    {{ logs | map(attribute='0') | unique | list | length }}
                </h5>
                <small class="text-muted">Unikátní uživatelé</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h5 class="text-info" id="unique-ips">
                    {{ logs | map(attribute='1') | unique | list | length }}
                </h5>
                <small class="text-muted">Unikátní IP adresy</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    let userFilter = document.getElementById('filter_user').value;
    let actionFilter = document.getElementById('filter_action').value;
    let successFilter = document.getElementById('filter_success').value;
    let dateFilter = document.getElementById('filter_date').value;
    
    let rows = document.querySelectorAll('.log-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let show = true;
        
        if (userFilter && row.dataset.user !== userFilter) show = false;
        if (actionFilter && row.dataset.action !== actionFilter) show = false;
        if (successFilter && row.dataset.success !== successFilter) show = false;
        if (dateFilter && row.dataset.date !== dateFilter) show = false;
        
        if (show) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('logs-count').textContent = `${visibleCount} záznamů`;
}

function clearFilters() {
    document.getElementById('filter_user').value = '';
    document.getElementById('filter_action').value = '';
    document.getElementById('filter_success').value = '';
    document.getElementById('filter_date').value = '';
    
    applyFilters();
}

function exportLogs() {
    // Získání viditelných řádků
    let visibleRows = Array.from(document.querySelectorAll('.log-row')).filter(row => row.style.display !== 'none');
    
    let csvContent = 'Čas,Uživatel,IP adresa,Akce,Výsledek,Detaily\n';
    
    visibleRows.forEach(row => {
        let cells = row.querySelectorAll('td');
        let rowData = [];
        
        cells.forEach(cell => {
            let text = cell.textContent.trim().replace(/\n/g, ' ').replace(/,/g, ';');
            rowData.push(`"${text}"`);
        });
        
        csvContent += rowData.join(',') + '\n';
    });
    
    let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `webdav_logs_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}

function clearLogs() {
    if (confirm('Opravdu chcete vymazat všechny logy?\nTato akce je nevratná!')) {
        // TODO: Implementovat mazání logů
        alert('🗑️ Funkce mazání logů bude implementována v další verzi');
    }
}

// Auto-refresh každých 30 sekund
setInterval(() => {
    if (!document.hidden) {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}